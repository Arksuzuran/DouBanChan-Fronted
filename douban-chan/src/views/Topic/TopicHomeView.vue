<!-- 话题版块主页 -->
<template>
  <div>
    <!-- 背景色 -->
    <div class="topichome-background"></div>

    <!-- 顶部二级导航栏 -->
    <div class="topichome-header-container">
      <div class="topichome-header-title">豆瓣话题酱</div>
      <!-- 按钮组 -->
      <div v-for="button in buttons" :key="button.id" class="topichome-header-btn"
        :class="getActiveButtonClass(button.id)" @click="handleSelect(button.id)">
        {{ button.label }}
      </div>
    </div>

    <!-- 下部内容区 -->
    <div class="topichome-main-container">
      <!-- 左部三级导航栏 -->
      <div class="topichome-left-container">
        <ContentSizerSideNavBar :labelList="labelList"></ContentSizerSideNavBar>
      </div>
      <!-- 中部页面的主要内容 -->
      <div class="topichome-mid-container">
        <GroupHomePostList :postList="inPostList"></GroupHomePostList>
      </div>
      <!-- 右部页面的主要内容 -->
      <div class="topichome-right-container">
        <GroupList :groupList="inGroupList" title="正在热议的小组" DIYCardComponentName="GroupCardWithTopic"></GroupList>
      </div>
    </div>

    <!-- 右下角 悬浮框 -->
    <!-- 创建小组 -->
    <GroupCreateBar v-if="isLogin"></GroupCreateBar>
    <!-- 滚动至顶部 -->
    <ScrollToTopButton class="group-likefav-scrollbutton"></ScrollToTopButton>
  </div>
</template>
  
<script>

import GroupHomePostList from '../Group/GroupHomePostList.vue'
import NavBarBackGround from '@/components/NavBarBackGround.vue'
import ScrollToTopButton from '@/components/post/button/ScrollToTopButton.vue'

import GroupList from '@/components/group/GroupList.vue'
import GroupCreateBar from '@/components/group/GroupCreateBar.vue'

import ContentSizerSideNavBar from '@/components/topic/ContentSizerSideNavBar.vue'

// 在需要使用vuex的场合下引入vuex
import { mapState, mapGetters, mapMutations, mapActions } from 'vuex'
export default {
  name: 'GroupHomeView',
  components: {
    NavBarBackGround,
    ScrollToTopButton,

    GroupHomePostList,
    GroupList,
    GroupCreateBar,

    ContentSizerSideNavBar,
  },
  data() {
    return {
      // 顶部筛选标签
      activeHeaderLabel: 0,
      // 按钮展示信息
      buttons: [
        { id: 0, label: '浏览发现' },
        { id: 1, label: '今日热榜' },
        { id: 2, label: '话题广场' },
      ],

      // 对应当前二级路由页面的筛选标签
      activeContentLabel: 0,
      // 侧边三级导航栏 筛选信息
      labelList: [
        { id: 0, label: '精选' },
        { id: 1, label: '生活' },
        { id: 2, label: '文化', },
        { id: 3, label: '影视' },
        { id: 4, label: '图书' },
        { id: 5, label: '游戏' },
        { id: 6, label: '我的话题' },
      ],

      // 帖子列表
      postList: [],
      // 小组列表
      groupList: [],
    }
  },
  methods: {
    // 处理顶部标签选择事件 当前选中的是哪个标签
    handleSelect(index) {
      console.log(index)
      console.log('用户点击标签', this.buttons[index].label)
      // 如果重复选择某个标签 那么视为取消选中 则默认退回到“精选”标签下
      if (this.activeHeaderLabel == index) {
        this.activeHeaderLabel = 0
      }
      // 选择不重复的标签
      else {
        this.activeHeaderLabel = index
      }
    },
    // 更新被选中标签的属性
    getActiveButtonClass(index) {
      if (this.activeHeaderLabel === index) {
        return 'topichome-header-btn-active'
      }
      return ''
    },
    // 返回精华帖列表
    getGoodPostList() {
      let goodPostList = []
      for (let post of this.postList) {
        if (post.isGoodPost) {
          goodPostList.push(post)
        }
      }
      return goodPostList
    },

    // 在此与后端交互
    // 在此与后端交互
    // 在此与后端交互

    // 命名规则：与后端交互相关的函数都带有Online
    // 获得帖子列表postLIst
    getPostListOnline() {
      return [
        {
          postId: 'p001',
          lzId: '004',
          lzName: "bochi",
          lzImageUrl: require('../../assets/user-image-7.jpg'),
          date: '2023-5-19 23:57',
          title: "我发游戏，你来打分",
          text: "0狗都不玩 1乏善可陈 2中规中矩 3值得一试 4不可多得的佳作 5神中神",
          postImageUrlList: [require('../../assets/group-img-3.png'),
          require('../../assets/group-img-4.png'),
          require('../../assets/group-img-5.jpg')],
          topic: '游戏',
          visits: 946126,
          fav: 15612,
          comments: 1692,
          like: 214512,
          dislike: 456,
          isTopped: true,
          isGoodPost: false,
          group: 'Game' //来自的小组
        },
        {
          postId: 'p002',
          lzId: '001',
          lzName: "羽毛笔",
          lzImageUrl: require('../../assets/user-image-1.jpg'),
          date: '2023-5-19 23:11',
          title: "理性讨论 软件工程基础和OS哪一个更精品",
          text: "压到真题了，主人奴隶问题：三个主人十个奴隶，在交易市场，主人可以通过窗口写入购买协议，奴隶可以查阅，请完成该问题的同步与互斥问题（基于异性主人奴隶问题的简化，无需性别互斥）",
          postImageUrlList: [require('../../assets/user-bg-3.jpg'), require('../../assets/group-img-2.jpg'),],
          topic: 'BUAA',
          visits: 5959261,
          fav: 20200,
          comments: 692,
          like: 59412,
          dislike: 59,
          isTopped: false,
          isGoodPost: true,
          group: '北京航空航天大学' //来自的小组
        },
        {
          lzId: '002',
          lzName: "Chino",
          lzImageUrl: require('../../assets/user-image-8.jpg'),
          date: '2023-5-02 22:47',
          title: "黑坤巴精神",
          text: "回来吧科比黑曼巴，我最骄傲的信仰，历历在目的球场，眼泪莫名在流淌，🤙依稀记得24🤙，🧟还有给力的八号🧟，把对手全都给打退，🚁就算坠机也不死🚁",
          postImageUrlList: [require('../../assets/group-img-6.jpg'), require('../../assets/group-img-7.jpg')],
          topic: '科比',
          visits: 59515,
          fav: 642,
          comments: 41,
          like: 595,
          dislike: 0,
          isTopped: false,
          isGoodPost: false,
          group: '牢大'       //来自的小组
        },
      ]
    },

    // 命名规则：与后端交互相关的函数都带有Online
    // 获得小组列表groupLIst
    // 此处的小组列表需要额外属性：aboutTopic:{topicId, topicName, topicAvatarUrl}
    // 即该小组是因为参与了这个话题 才被推送上来的
    getGroupListOnline() {
      return [
        {
          groupId: 'g001',
          groupHeadBgUrl: require('../../assets/user-image-7.jpg'),
          groupAvatarImgUrl: require('../../assets/group-avatar-1.jpg'),
          groupName: "集美小组集美小组集美小组",
          groupIntro: "家人们谁懂啊，咱就是说一整个无语住了，一把子大动作给到了，今天又是在逃公主的一天，九敏九敏真的太好哭了吧，下头男",
          tagList: ['生活', '文化'],
          groupPostNumber: 321,
          groupFollowNumber: 594,
          aboutTopic:{topicId:'t001', topicName:'游戏', topicAvatarUrl:require('../../assets/topic-avatar-1.jpg')},
          memberList: [
            {
              userId: '001',
              userName: "羽毛笔",
              userImageUrl: require('../../assets/user-image-1.jpg'),
              isAdmin: true,
            },
            {
              userId: '004',
              userName: "bochi",
              userImageUrl: require('../../assets/user-image-7.jpg'),
              isAdmin: false,
            },
          ],
        },
        {
          groupId: 'g002',
          groupHeadBgUrl: require('../../assets/user-bg-4.jpg'),
          groupAvatarImgUrl: require('../../assets/group-avatar-2.jpg'),
          groupName: "coding小组",
          groupIntro: "编程爱好者聚集地",
          tagList: ['生活', '游戏', '文化'],
          groupPostNumber: 597,
          groupFollowNumber: 792,
          aboutTopic:{topicId:'t001', topicName:'游戏', topicAvatarUrl:require('../../assets/topic-avatar-1.jpg')},
          memberList: [
            {
              userId: '001',
              userName: "羽毛笔",
              userImageUrl: require('../../assets/user-image-1.jpg'),
              isAdmin: false,
            },
            {
              userId: '002',
              userName: "Chino",
              userImageUrl: require('../../assets/user-image-8.jpg'),
              isAdmin: true,
            },
            {
              userId: '003',
              userName: "_Karasu_",
              userImageUrl: require('../../assets/user-image-6.jpg'),
              isAdmin: true,
            },
            {
              userId: '004',
              userName: "bochi",
              userImageUrl: require('../../assets/user-image-7.jpg'),
              isAdmin: false,
            },
          ],
        },
        {
          groupId: 'g003',
          groupHeadBgUrl: require('../../assets/group-img-8.jpg'),
          groupAvatarImgUrl: require('../../assets/group-avatar-3.jpg'),
          groupName: "蔚蓝档案小组",
          groupIntro: "联邦理事会宣布对此事件负责",
          tagList: ['游戏'],
          groupPostNumber: 1367,
          groupFollowNumber: 59521,
          aboutTopic:{topicId:'t002', topicName:'BUAA', topicAvatarUrl:require('../../assets/topic-avatar-2.jpg')},
          memberList: [
            {
              userId: '002',
              userName: "Chino",
              userImageUrl: require('../../assets/user-image-8.jpg'),
              isAdmin: true,
            },
            {
              userId: '003',
              userName: "_Karasu_",
              userImageUrl: require('../../assets/user-image-6.jpg'),
              isAdmin: false,
            },
          ],
        },
      ]
    },
  },
  computed: {
    // 要传递的小组列表
    inGroupList() {
      // 筛选我的小组
      // 该功能应该由后端实现 此处只是假筛选
      if (this.activeHeaderLabel == 6) {
        let list = []
        for (let group of this.groupList) {
          for (let member of group.memberList) {
            if (member.userId === this.userId) {
              list.push(group)
              break
            }
          }
        }
        return list
      }
      else {
        return this.groupList
      }
    },


    //要传递的帖子列表
    inPostList() {
      if (this.activeHeaderLabel == 0) {
        return this.postList.slice()
      }
      else if (this.activeHeaderLabel == 1) {
        return this.getGoodPostList()
      }
      return []
    },
    // 用户是否选中了'我的小组'
    // 用户是否选择‘我的小组’标签
    // 这里姑且以字符串来比较 因为后面大概率改id顺序
    usersGrouplabelChoosen() {
      return this.buttons[this.activeHeaderLabel].label == '我的小组'
    },

    //头像路径与用户名
    //引入vuex的userAbout模块里的 state变量
    ...mapState('userAbout', ['userName', 'userImgUrl', 'isLogin', 'userId']),
  },

  mounted() {
    // 获取数据
    this.postList = this.getPostListOnline()
    this.groupList = this.getGroupListOnline()

    // 监听GroupCreateBar的创建小组事件，在事件回调中将新小组添加到列表
    this.$bus.$on('groupCreated', (newGroup) => {
      this.groupList.push(newGroup);
      console.log('用户创建小组成功：', newGroup)
    });
  },

}
</script>
  
<style scoped>
/* 内容区容器 */
/* 主容器 */
.topichome-main-container {
  width: 80%;
  margin: 0 auto;
  background-color: rgb(255, 251, 251);

  display: flex;
  justify-content: space-around;
  align-items: flex-start;
  flex-flow: row wrap;
}

/* 左侧导航栏 */
.topichome-left-container {
  flex: 2;

}
/* 中部内容区 */
.topichome-mid-container {
  flex: 10;
}
/* 右侧随机推荐区 */
.topichome-right-container {
  flex: 4;
}

/* 滚动至顶部 */
.group-likefav-scrollbutton {
  position: fixed;
  bottom: 150px;
  right: 20px;
}

/* 页面背景色 */
.topichome-background {
  position: fixed;
  width: 100%;
  height: 100%;
  background-color: rgb(255, 248, 248);
  z-index: -2;
}

/* 顶部二级导航栏容器 */
.topichome-header-container {
  padding: 0 11%;
  position: sticky;
  top: 65px;
  z-index: 11;

  height: 90px;

  background-color: rgb(255, 237, 237);
  display: flex;
  flex-flow: row wrap;
  justify-content: flex-start;
  align-items: center;
}

/* 页面顶栏处标题 */
.topichome-header-title {
  margin: 0 40px;
  font-size: 36px;
  font-weight: 700;
  color: rgba(255, 133, 133, 0.9);
}

/* 顶栏 筛选器 组件 */
/* === removing default button style ===*/
/* === removing default button style ===*/
/* 按钮基本样式 */
.topichome-header-btn {
  margin: 0 15px;

  font-size: 18px;
  background: transparent;
  border: none;
  padding: 12px 18px;
  color: rgba(255, 133, 133, 0.9);
  text-transform: uppercase;
  position: relative;
  transition: .5s ease;

  cursor: pointer;
}

.topichome-header-btn::before {
  content: '';
  position: absolute;
  left: 0;
  bottom: 0;
  height: 2px;
  width: 0;
  background-color: rgba(255, 66, 66, 0.9);
  transition: .5s ease;
}

.topichome-header-btn:hover,
.topichome-header-btn.topichome-header-btn-active {
  color: #ffffff;
  transition-delay: .5s;
}

.topichome-header-btn-active {
  border-radius: 10px;
  transition: .5s ease;
  background-color: rgb(255, 97, 97);
}

.topichome-header-btn:hover::before,
.topichome-header-btn.topichome-header-btn-active::before {
  width: 100%;
}

.topichome-header-btn::after {
  content: '';
  position: absolute;
  left: 0;
  bottom: 0;
  height: 0;
  width: 100%;
  border-radius: 10px;
  background-color: rgba(255, 154, 154, 0.8);
  transition: .4s ease;
  z-index: -1;
}

.topichome-header-btn:hover::after,
.topichome-header-btn.topichome-header-btn-active::after {
  height: 100%;
  transition-delay: 0.4s;
  color: aliceblue;
}
</style>